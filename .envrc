#!/usr/bin/env bash
# Auto-load host-specific env vars whenever a shell enters the repo.
# Requires direnv (https://direnv.net). After installing direnv and
# running `direnv allow` once, this script will keep BEACH_ICE_PUBLIC_IP
# in sync with the host's LAN IP so dockerized beach-manager can publish
# a reachable ICE candidate without manual edits to .env files.

set -euo pipefail

is_global_ip() {
	local ip="$1"
	[[ -z "$ip" ]] && return 1
	case "$ip" in
		127.*|0.0.0.0|169.254.*|::1) return 1 ;;
		192.168.65.*) return 1 ;;
	esac
	return 0
}

ipconfig_ips() {
	local iface ip
	if command -v ipconfig >/dev/null 2>&1; then
		for iface in en0 en1 en2; do
			ip=$(ipconfig getifaddr "$iface" 2>/dev/null || true)
			[[ -n "$ip" ]] && printf '%s\n' "$ip"
		done
	fi
}

collect_ips() {
	local ip
	if command -v ifconfig >/dev/null 2>&1; then
		ifconfig | awk '/inet / {print $2}' | while read -r ip; do
			[[ -n "$ip" && "$ip" != "127.0.0.1" ]] && echo "$ip"
		done
	fi
	if command -v ip >/dev/null 2>&1; then
		ip addr | awk '/inet / {print $2}' | cut -d'/' -f1
	fi
	if command -v ip >/dev/null 2>&1; then
		ip route get 1.1.1.1 2>/dev/null | awk '/src/ {print $7; exit}'
	fi
}

detect_host_ip() {
	local candidate=""
	local ip
	for ip in $(ipconfig_ips); do
		ip="${ip%%/.*}"
		[[ -n "$ip" ]] && echo "$ip" && return
	done

	while IFS= read -r ip; do
		ip="${ip%%/.*}"
		if [[ -n "$ip" ]] && is_global_ip "$ip"; then
			echo "$ip"
			return
		elif [[ -z "$candidate" ]]; then
			candidate="$ip"
		fi
	done < <(collect_ips | uniq)
	echo "$candidate"
}

if [[ -z "${BEACH_ICE_PUBLIC_IP:-}" ]]; then
	host_ip=$(detect_host_ip)
	if [[ -n "$host_ip" ]]; then
		export BEACH_ICE_PUBLIC_IP="$host_ip"
		export BEACH_ICE_PUBLIC_HOST="$host_ip"
		export BEACH_ICE_PUBLIC_AUTO=1
	fi
fi

if [[ -n "${BEACH_ICE_PUBLIC_IP:-}" ]]; then
	export BEACH_HOST_LAN_IP="${BEACH_ICE_PUBLIC_IP}"
fi
