# Pong Showcase Connection Diagnosis – 2025-11-14

## Summary
- Both CLI hosts (LHS `67f1717e-…`, RHS `1788671f-…`) keep logging `skipping auto-attach; bearer token unavailable`. They never call `attach-by-code` with valid manager credentials, so they remain unauthenticated controller sessions and never poll `/sessions/{id}/actions`.
- Fast-path registration never succeeds: Beach Manager logs repeatedly show `fast-path session not registered; falling back to HTTP`. `docker logs beach-manager` and host logs show continuous ICE disconnects around 17:22 UTC. The WebRTC internals dump contains no candidate pairs.
- Because both fast-path and HTTP fallback are down, the controller forwarders enqueue actions but nothing delivers them, so the paddles never move.

## Evidence
- Host logs: `~/beach-debug/beach-host-lhs.log:139319134` (and RHS) show repeated `skipping auto-attach; bearer token unavailable … manager=http://127.0.0.1:8080`.
- Manager logs: `logs/beach-manager/beach-manager.log` contains only `fast-path session not registered; falling back to HTTP` entries for the new session IDs (e.g. lines around `73428687`, `73436721`, `73484648`). No `dispatched actions via fast-path` or controller delivery logs follow.
- WebRTC: `docker logs beach-manager` shows nothing but `ICE connection state changed: disconnected/failed` for the relevant timeframe. `temp/webrtc_internals_dump` has zero candidate pairs captured.

## Root Cause
1. Hosts were launched without a valid manager bearer token (`PB_MANAGER_TOKEN` / `beach login`), so they could not complete `attach-by-code`. The manager handshake provides controller tokens but not bearer credentials. Without attach, the controller forwarder’s HTTP fallback channel never polls actions.
2. Simultaneously, the fast-path WebRTC connections oscillate between `Connected` and `Disconnected` states and are never registered with the manager’s fast-path registry, so `send_actions_over_fast_path` always falls back to HTTP.

With both delivery channels unavailable, the agent’s `queue_action` calls pile up and eventually time out.

## Remediation implemented
1. Added a tracked root `.env.local` and taught `docker-compose.yml` to load both `.env` and `.env.local` for the Beach Manager service. The default `.env.local` now sets `BEACH_ICE_PUBLIC_IP=127.0.0.1` and defines the UDP port range, so the container always advertises a host-reachable ICE address without developers exporting anything manually. Developers can override the file with their LAN IP if they need to drive CLI hosts from another machine.
2. Existing instructions still require running the CLI hosts with a valid manager bearer token (`PB_MANAGER_TOKEN` or `beach login`). Without that, auto-attach continues to fail, so make sure the env var/profile is configured before launching the LHS/RHS commands.

With these two changes, fast-path handshakes will advertise an address the local hosts can reach, and the forwarder will stay online as long as the hosts provide a token. Once both hosts attach successfully, the agent’s `queue_action` calls should flow through fast-path without the timeouts we observed.
